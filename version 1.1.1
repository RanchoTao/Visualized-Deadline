import pygame
import sys
import numpy as np
from datetime import datetime, timedelta

# 初始化 Pygame
pygame.init()

# 常量定义
WIDTH, HEIGHT = 1000, 700
MATRIX_TOP_LEFT = (100, 100)  # 矩阵左上角坐标
MATRIX_WIDTH, MATRIX_HEIGHT = 800, 500  # 矩阵区域大小
TASK_RADIUS = 15
FPS = 60

# 颜色定义
WHITE = (255, 255, 255)
BLACK = (0, 0, 0)
GRAY = (200, 200, 200)
RED = (255, 100, 100)
GREEN = (100, 255, 100)
BLUE = (100, 100, 255)
YELLOW = (255, 255, 100)
QUADRANT_COLORS = [
    (200, 200, 255),   # 左上 Q2 - 蓝色调 (重要，不紧急)
    (255, 200, 200),   # 右上 Q1 - 红色调 (重要，紧急)
    (255, 255, 200),   # 右下 Q3 - 黄色调 (不重要，紧急)
    (200, 255, 200)    # 左下 Q4 - 绿色调 (不重要，不紧急)
]

# 创建窗口
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("动态任务矩阵 (艾森豪威尔矩阵)")
clock = pygame.time.Clock()
font = pygame.font.SysFont('simhei', 20)  # 使用黑体，支持中文
title_font = pygame.font.SysFont('simhei', 24, bold=True)

class Task:
    """任务类"""
    def __init__(self, id, title, description, importance, urgency, creation_date, deadline):
        self.id = id
        self.title = title
        self.description = description
        self.importance = np.clip(importance, 0.0, 1.0)  # 重要性 [0, 1]
        self.urgency = np.clip(urgency, 0.0, 1.0)       # 紧急性 [0, 1]
        self.creation_date = creation_date
        self.deadline = deadline
        self.color = self.calculate_color()
        self.being_dragged = False  # 是否正在被拖拽
        self.detail_visible = False # 详情是否显示

    def calculate_color(self):
        """根据紧急和重要程度计算颜色 (示例：越红越紧急，越绿越重要)"""
        r = int(150 + 100 * self.urgency)   # 紧急度影响红色通道
        g = int(150 + 100 * self.importance) # 重要度影响绿色通道
        b = 150
        return (r, g, b)

    def get_screen_pos(self):
        """将标准化坐标转换为屏幕坐标"""
        x = MATRIX_TOP_LEFT[0] + self.urgency * MATRIX_WIDTH
        y = MATRIX_TOP_LEFT[1] + (1 - self.importance) * MATRIX_HEIGHT  # Y轴从上往下增加，所以用1减
        return (int(x), int(y))

    def contains_point(self, point):
        """检查点是否在任务点内"""
        task_pos = self.get_screen_pos()
        distance = np.sqrt((point[0] - task_pos[0])**2 + (point[1] - task_pos[1])**2)
        return distance <= TASK_RADIUS

    def draw(self, surface):
        """绘制任务点"""
        pos = self.get_screen_pos()
        color = RED if self.being_dragged else self.color  # 被拖拽时高亮为红色

        # 绘制任务点
        pygame.draw.circle(surface, color, pos, TASK_RADIUS)
        pygame.draw.circle(surface, BLACK, pos, TASK_RADIUS, 2)  # 黑色边框

        # 如果详情可见，绘制详细信息框
        if self.detail_visible:
            self.draw_detail(surface, pos)

    def draw_detail(self, surface, task_pos):
        """绘制任务详细信息框"""
        # 信息框尺寸和位置
        info_width, info_height = 300, 150
        # 确保信息框显示在屏幕内
        info_x = task_pos[0] + 20
        info_y = task_pos[1] - info_height // 2

        if info_x + info_width > WIDTH:
            info_x = task_pos[0] - info_width - 20
        if info_y + info_height > HEIGHT:
            info_y = HEIGHT - info_height - 10

        # 绘制半透明背景
        s = pygame.Surface((info_width, info_height), pygame.SRCALPHA)
        s.fill((50, 50, 50, 240))  # 深灰色，半透明
        surface.blit(s, (info_x, info_y))

        # 绘制边框
        pygame.draw.rect(surface, WHITE, (info_x, info_y, info_width, info_height), 2)

        # 绘制文本
        y_offset = info_y + 10
        title_surf = title_font.render(f"任务: {self.title}", True, WHITE)
        surface.blit(title_surf, (info_x + 10, y_offset)); y_offset += 30

        desc_surf = font.render(f"描述: {self.description}", True, WHITE)
        surface.blit(desc_surf, (info_x + 10, y_offset)); y_offset += 25

        imp_surf = font.render(f"重要性: {self.importance:.2f}", True, GREEN)
        surface.blit(imp_surf, (info_x + 10, y_offset)); y_offset += 25

        urg_surf = font.render(f"紧急性: {self.urgency:.2f}", True, RED)
        surface.blit(urg_surf, (info_x + 10, y_offset)); y_offset += 25

        # 计算剩余天数
        days_left = (self.deadline - datetime.now()).days
        days_surf = font.render(f"剩余天数: {days_left}", True, YELLOW)
        surface.blit(days_surf, (info_x + 10, y_offset))

# 创建示例任务
tasks = [
    Task("1", "备考英语六级", "完成至少5套真题，重点练习听力与阅读", 0.9, 0.8, 
         datetime.now() - timedelta(days=10), datetime.now() + timedelta(days=20)),
    Task("2", "完成数学分析作业", "完成第三章习题，理清极限概念", 0.7, 0.6,
         datetime.now() - timedelta(days=2), datetime.now() + timedelta(days=7)),
    Task("3", "机器学习项目", "复现论文中的基础模型", 0.8, 0.3,
         datetime.now() - timedelta(days=30), datetime.now() + timedelta(days=60)),
    Task("4", "阅读课外书籍", "每周阅读30页专业相关书籍", 0.5, 0.2,
         datetime.now(), datetime.now() + timedelta(days=365)),
]

# 主循环
selected_task = None  # 当前被拖拽的任务
running = True

while running:
    mouse_pos = pygame.mouse.get_pos()
    
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

        # 鼠标按下事件
        elif event.type == pygame.MOUSEBUTTONDOWN:
            if event.button == 1:  # 左键
                # 检查是否点击了任务点
                clicked_task = None
                for task in tasks:
                    if task.contains_point(mouse_pos):
                        clicked_task = task
                        break

                if clicked_task:
                    # 如果点击了任务点，开始拖拽或显示详情
                    if selected_task is None:
                        selected_task = clicked_task
                        selected_task.being_dragged = True
                    # 点击另一个任务点，切换详情显示
                    for t in tasks:
                        t.detail_visible = (t is clicked_task and not t.detail_visible)
                else:
                    # 点击空白处，取消所有任务的详情显示和被拖拽状态
                    for task in tasks:
                        task.detail_visible = False
                        if task.being_dragged:
                            task.being_dragged = False
                            selected_task = None

        # 鼠标释放事件
        elif event.type == pygame.MOUSEBUTTONUP:
            if event.button == 1 and selected_task:  # 左键释放且有被拖拽的任务
                selected_task.being_dragged = False
                selected_task = None

        # 鼠标拖拽事件 (持续触发)
        elif event.type == pygame.MOUSEMOTION:
            if selected_task and selected_task.being_dragged:
                # 将鼠标位置转换为紧急度和重要度
                rel_x = (mouse_pos[0] - MATRIX_TOP_LEFT[0]) / MATRIX_WIDTH
                rel_y = 1 - (mouse_pos[1] - MATRIX_TOP_LEFT[1]) / MATRIX_HEIGHT

                # 限制在[0,1]范围内
                new_urgency = np.clip(rel_x, 0.0, 1.0)
                new_importance = np.clip(rel_y, 0.0, 1.0)

                selected_task.urgency = new_urgency
                selected_task.importance = new_importance
                selected_task.color = selected_task.calculate_color()  # 更新颜色

    # --- 绘制开始 ---
    screen.fill(WHITE)

    # 绘制矩阵区域和四个象限
    quadrant_rects = [
        (MATRIX_TOP_LEFT[0], MATRIX_TOP_LEFT[1], MATRIX_WIDTH/2, MATRIX_HEIGHT/2), # Q2
        (MATRIX_TOP_LEFT[0] + MATRIX_WIDTH/2, MATRIX_TOP_LEFT[1], MATRIX_WIDTH/2, MATRIX_HEIGHT/2), # Q1
        (MATRIX_TOP_LEFT[0] + MATRIX_WIDTH/2, MATRIX_TOP_LEFT[1] + MATRIX_HEIGHT/2, MATRIX_WIDTH/2, MATRIX_HEIGHT/2), # Q3
        (MATRIX_TOP_LEFT[0], MATRIX_TOP_LEFT[1] + MATRIX_HEIGHT/2, MATRIX_WIDTH/2, MATRIX_HEIGHT/2)  # Q4
    ]

    for i, rect in enumerate(quadrant_rects):
        pygame.draw.rect(screen, QUADRANT_COLORS[i], rect)

    # 绘制坐标轴
    pygame.draw.line(screen, BLACK, 
                    (MATRIX_TOP_LEFT[0], MATRIX_TOP_LEFT[1] + MATRIX_HEIGHT/2),
                    (MATRIX_TOP_LEFT[0] + MATRIX_WIDTH, MATRIX_TOP_LEFT[1] + MATRIX_HEIGHT/2), 3)  # X轴
    pygame.draw.line(screen, BLACK, 
                    (MATRIX_TOP_LEFT[0] + MATRIX_WIDTH/2, MATRIX_TOP_LEFT[1]),
                    (MATRIX_TOP_LEFT[0] + MATRIX_WIDTH/2, MATRIX_TOP_LEFT[1] + MATRIX_HEIGHT), 3)  # Y轴

    # 绘制坐标轴标签
    birth_label = font.render("Birthline", True, BLUE)
    deadline_label = font.render("Deadline", True, RED)
    importance_label = font.render("Importance", True, GREEN)
    low_imp_label = font.render("(Low)", True, BLACK)
    high_imp_label = font.render("(High)", True, BLACK)
    low_urg_label = font.render("(Low)", True, BLACK)
    high_urg_label = font.render("(High)", True, BLACK)

    screen.blit(birth_label, (MATRIX_TOP_LEFT[0] - 10, MATRIX_TOP_LEFT[1] + MATRIX_HEIGHT + 20))
    screen.blit(deadline_label, (MATRIX_TOP_LEFT[0] + MATRIX_WIDTH - 70, MATRIX_TOP_LEFT[1] + MATRIX_HEIGHT + 20))
    screen.blit(importance_label, (MATRIX_TOP_LEFT[0] - 100, MATRIX_TOP_LEFT[1] - 30))
    screen.blit(low_imp_label, (MATRIX_TOP_LEFT[0] - 40, MATRIX_TOP_LEFT[1] + MATRIX_HEIGHT + 5))
    screen.blit(high_imp_label, (MATRIX_TOP_LEFT[0] - 40, MATRIX_TOP_LEFT[1] - 20))
    screen.blit(low_urg_label, (MATRIX_TOP_LEFT[0] - 40, MATRIX_TOP_LEFT[1] + MATRIX_HEIGHT + 5))
    screen.blit(high_urg_label, (MATRIX_TOP_LEFT[0] + MATRIX_WIDTH - 40, MATRIX_TOP_LEFT[1] + MATRIX_HEIGHT + 5))

    # 绘制象限标签
    q2_label = font.render("重要，不紧急", True, BLACK)
    q1_label = font.render("重要，紧急", True, BLACK)
    q3_label = font.render("不重要，紧急", True, BLACK)
    q4_label = font.render("不重要，不紧急", True, BLACK)

    screen.blit(q2_label, (MATRIX_TOP_LEFT[0] + 20, MATRIX_TOP_LEFT[1] + 20))
    screen.blit(q1_label, (MATRIX_TOP_LEFT[0] + MATRIX_WIDTH/2 + 20, MATRIX_TOP_LEFT[1] + 20))
    screen.blit(q3_label, (MATRIX_TOP_LEFT[0] + MATRIX_WIDTH/2 + 20, MATRIX_TOP_LEFT[1] + MATRIX_HEIGHT/2 + 20))
    screen.blit(q4_label, (MATRIX_TOP_LEFT[0] + 20, MATRIX_TOP_LEFT[1] + MATRIX_HEIGHT/2 + 20))

    # 绘制所有任务点
    for task in tasks:
        task.draw(screen)

    # 绘制标题
    title_label = title_font.render("动态任务矩阵 - 艾森豪威尔法则", True, BLACK)
    screen.blit(title_label, (WIDTH//2 - title_label.get_width()//2, 30))

    # 绘制操作说明
    instructions = [
        "操作说明:",
        "- 点击任务点: 查看/隐藏详细信息",
        "- 拖拽任务点: 调整其重要性和紧急性",
        "- 点击空白处: 隐藏所有详细信息"
    ]
    
    for i, line in enumerate(instructions):
        instr_surf = font.render(line, True, BLACK)
        screen.blit(instr_surf, (50, HEIGHT - 120 + i * 25))

    pygame.display.flip()
    clock.tick(FPS)

pygame.quit()
sys.exit()
